syntax = "proto3";

package principal.v1;

// PrincipalService provides public key lookup and revocation info
// for API servers to verify worker JWTs.
// These endpoints are PUBLIC (no auth required) for MVP.
service PrincipalService {
  // GetPublicKey fetches a worker's public key by fingerprint.
  // Used by API server to verify worker JWTs (cached via HTTP).
  // This RPC is idempotent and cacheable.
  rpc GetPublicKey(GetPublicKeyRequest) returns (GetPublicKeyResponse) {}

  // ListRevokedPrincipals returns all currently revoked fingerprints.
  // Used by API server to maintain revocation blocklist (polled every 5 min).
  rpc ListRevokedPrincipals(ListRevokedPrincipalsRequest) returns (ListRevokedPrincipalsResponse) {}
}

// CredentialService provides credential management for web UI.
// These endpoints require authentication (session-based).
service CredentialService {
  // ImportCredential imports a worker credential from a base58-encoded blob.
  // Creates a new worker principal and stores the public key.
  rpc ImportCredential(ImportCredentialRequest) returns (ImportCredentialResponse) {}

  // ListCredentials returns all credentials (principals) for the current user's org.
  rpc ListCredentials(ListCredentialsRequest) returns (ListCredentialsResponse) {}

  // RevokeCredential revokes a credential by principal ID.
  // Adds fingerprint to revocation list and soft-deletes principal.
  rpc RevokeCredential(RevokeCredentialRequest) returns (RevokeCredentialResponse) {}
}

// GetPublicKey messages
message GetPublicKeyRequest {
  // Base58-encoded fingerprint of the public key
  string fingerprint = 1;
}

message GetPublicKeyResponse {
  // Base58-encoded fingerprint (echoed from request)
  string fingerprint = 1;

  // PEM-encoded ECDSA P-256 public key
  string public_key_pem = 2;

  // Organization ID (UUIDv7 as string)
  string org_id = 3;
}

// ListRevokedPrincipals messages
message ListRevokedPrincipalsRequest {
  // Empty for MVP
  // Future: pagination, since timestamp, etc.
}

message ListRevokedPrincipalsResponse {
  // List of revoked fingerprints (base58-encoded)
  repeated string fingerprints = 1;
}

// ImportCredential messages
message ImportCredentialRequest {
  // Base58-encoded credential blob containing public key and metadata
  string blob = 1;
}

message ImportCredentialResponse {
  // UUIDv7 as string
  string principal_id = 1;

  // UUIDv7 as string
  string org_id = 2;

  // Roles assigned to this credential
  repeated string roles = 3;

  // Base58-encoded fingerprint
  string fingerprint = 4;

  // Credential name from blob
  string name = 5;
}

// ListCredentials messages
message ListCredentialsRequest {
  // Optional filter by principal type: "user", "worker", "service"
  // Empty string means all types
  string principal_type = 1;
}

message Credential {
  // UUIDv7 as string
  string principal_id = 1;

  // UUIDv7 as string
  string org_id = 2;

  // Principal type: "user", "worker", "service"
  string type = 3;

  // Display name
  string name = 4;

  // Base58-encoded fingerprint (empty for user principals)
  string fingerprint = 5;

  // Roles assigned to this principal
  repeated string roles = 6;

  // RFC3339 timestamp
  string created_at = 7;

  // RFC3339 timestamp (optional)
  string last_used_at = 8;
}

message ListCredentialsResponse {
  // List of credentials
  repeated Credential credentials = 1;
}

// RevokeCredential messages
message RevokeCredentialRequest {
  // UUIDv7 as string
  string principal_id = 1;
}

message RevokeCredentialResponse {
  // Empty response (success indicated by no error)
}
